# Platform v12 migration guide: Vite & React 18

Good news! Vite and React 18 in the app platform are ready to use!

We‚Äôre very excited for these updates ‚Äî Vite will be a big upgrade from Create React App, which we used under the hood to build and serve apps previously, and it will open up some powerful new possibilities for the platform.

Here are some tips about what to expect, and how to easily upgrade to the latest version of `@dhis2/cli-app-scripts` to take advantage of Vite and React 18.

### Notable changes

These are some things that you‚Äôll see right away:

-   It‚Äôs fast! Starting up an app is nearly instant, and building an app is about 3-4 times faster than before
-   Plugins are handled better:
    -   Start-up of both the app and plugin is nearly instant
    -   The app and plugin are run on the same port
    -   Support for a plugin without an app is improved
    -   Code is shared between entrypoints, which makes bundles smaller
    -   HMR for code changes in the plugin will be as fast as in the app
-   There‚Äôs a small suite of tools available in the CLI when running an app in dev mode:
    -   With the dev server running, press `h + enter` to see the options
    -   Options include exposing the server on LAN, opening the app in the browser, cleanly quitting the server, and restarting the dev server (which can be helpful if you‚Äôre modifying libraries in node_modules ‚Äî see more below)
-   Build output summary to inspect chunks

### Future changes

With Vite, the door is open for some big future improvements:

-   Extensible config: developers can add their own options to the Vite config, for example a plugin for Flow types, or to define import aliases
-   Arbitrary entrypoints, beyond app/plugin/lib: Make a regular app, a configuration app, a capture plugin, a dashboard plugin, and more all from the same repo and sharing code between them

## Getting started

Our goal is to make it easy to adopt the new changes, so we have some tools to facilitate the process.

### Initial start

By running these steps, you should be able to run your app right away:

1. `yarn add @dhis2/app-runtime @dhis2/ui -D @dhis2/cli-app-scripts`
2. `npx yarn-deduplicate yarn.lock && yarn`
3. Try out `yarn start ‚ÄîallowJsxInJs`, and your app should be running üöÄ

## Vite & JSX

As suggested by the `‚ÄîallowJsxInJs` flag, Vite does not allow JSX syntax in files without a .jsx or .tsx extension by default; attempting to run `start` or `build` in that case will throw an error like `‚úò [ERROR] The JSX syntax extension is not currently enabled`.

JSX in .js files is not supported for performance reasons: it saves needing to parse non-JSX files for JSX syntax. We can add complicated config to enable parsing of JSX in .js files, but that approach has several downsides:

1. It‚Äôs nonstandard ‚Äî it is most correct to use the right file extensions
2. It requires more config to maintain
3. It has performance costs on startup and when parsing files
   The new default for `@dhis2/cli-app-scripts`, therefore, will be the same as Vite‚Äôs. To make the transition easier, though, we provide some tools to 1) support JSX in .js files temporarily, and 2) easily migrate JS files to .jsx extensions if they contain JSX syntax.

### Allow JSX in JS temporarily

To make it as fast as possible to upgrade and get up and running with Vite and React 18, we added an `--allowJsxInJs` flag that you can pass to `start` and `build` scripts, so that you can test out the changes without any file renaming. In many cases, you should be able to upgrade your platform dependencies and run `start` with the flag and see your app running! Other times, you may need to add a few tweaks ‚Äî see the troubleshooting and breaking changes sections below.

Due to the downsides mentioned above, however, we will remove the `‚ÄîallowJsxInJs` option in the next major version. When you are ready to rename your files, you can use the migration script we‚Äôve made.

### .js to .jsx migration script

We made a codemod that can migrate your codebase to the right file extensions quickly! It checks .js files for JSX syntax, updates the extension if needed, then updates imports within the file tree to target the new filenames.

```sh
yarn d2-app-scripts migrate js-to-jsx
```

Check out the [script docs](../scripts/migrate/js-to-jsx.md) for options, tips, and caveats.

## React 18

In terms of the React 18-related changes, upgrading to `@dhis2/cli-app-scripts` version 12 should generally a smooth process for the consuming apps. Most of the [changes](https://react.dev/blog/2022/03/08/react-18-upgrade-guide) shouldn't affect most apps.

### Default props

The main change in React 18 that is expected to affect apps at runtime is that using `MyComponent.defaultProps = { ... }` is deprecated [todo: just for functional components?], and will be removed in the next version. While non-breaking, this change comes along with warning messages in the console for every rendered component that uses them, which can be chatty and annoying.

The fix is to move prop defaults -- either to default parameters for functional components, or to a static property for class components. This code mod can help with the migration, and was used for the `@dhis2/ui` library: [transform.js](https://gist.github.com/kabaros/45ed16660ac89dc48d22e03836b1e981)

**NB!** Note that default params for functional components are computed on each render, so default values like arrays and objects as defaults may unintentionally retrigger `useEffect` and `useMemo` functions on each render. Instead, use a stable reference like so:

```js
const arr = []
const MyComponent = ({ options = arr }) => {
    /* ... */
}
```

### Tests

React 18 has minimal effects on the operation of an app in a browser, but it has a more significant effect on tests, depending on what tools are used and how the tests are written.

#### React Testing Library

Testing-library supports React 18 since v13, so the first step is to upgrade that library and the supporting libraries around it. These major versions bumps come with a few breaking changes that we're trying to document here:

-   `userEvent` is async now in `@testing-library/user-event`. Check the [release notes](https://github.com/testing-library/user-event/releases/tag/v14.0.0) for an idea of the improvements and new API
    -   In practice, this means mostly that you'd need to add an `await` for `userEvent` interactions like `userEvent.click()`
-   `renderHook` is not a separate library anymore; it is part of the `@testing-library/react`, and it has quite a different API. NB: most docs online still point to the old version, which can be confusing.
    -   Use `import { renderHook } from '@testing-library/react'` instead of `import { renderHook } from '@testing-library/react-hooks`
    -   The return type for renderHook is different. One major difference is the absence of `waitForNextUpdate` returned from `renderHook`. Now it can be replaced with the `waitFor` from `@testing-library`, and adding an expectation to wait for, for example.
    -   Testing hooks that throw errors is different. Use `expect(renderHook(() => { ... })).toThrow(....)`
-   Faking timers can help with tests that seem to fail with concurrency issues

[To do: add details to each bullet; get examples from PRs]

#### Enzyme

Enzyme is considered dead: https://dev.to/wojtekmaj/enzyme-is-dead-now-what-ekl. There is no official adapter for React 18 (or 17), so it's best to [migrate to React Testing Library](https://testing-library.com/docs/react-testing-library/migrate-from-enzyme/) for tests, if possible.

If it's not currently possible to migrate, there is an [unofficial React 18 adapter](https://github.com/cfaester/enzyme-adapter-react-18) that can help in the mean time.

## Troubleshooting & tips

-   There is a bug in Vite: importing from a directory, e.g. `‚Äò./app/‚Äò` where we would assume to get `./app/index.[jt]s`, can incorrectly resolve to a file with a similar name to the directory, e.g. `./App.tsx`. I see this as a bug with Vite, but as a workaround, file and dir names can be changed so they don‚Äôt conflict. Noticed in the Maintenance app beta.
-   If you‚Äôre using `identity-obj-proxy` in your test config, make sure you add it to the project‚Äôs dependencies. Previously, some apps got away with using the proxy without an explicitid dependency because the package is a dependency of `react-scripts`
-   You may see some build warnings coming from the `mathjs` package. Upgrading to a recent version of `mathjs` will handle these warnings. Noticed in analytics app (the analytics library has a dependency on `mathjs`)

### Summary of breaking changes

1. Node 18 || 20+ is required
2. JSX in files without .jsx or .tsx extensions is not supported by default
3. Flow types won‚Äôt work (this is a motivator for extensible config)
4. Import aliases will likely break (same as above)
5. `global.variableName` is no longer supported; use `window.variableName` instead
6. In order to make the dev server available on LAN, the `--host` flag needs to be passed to the start script
7. Workers imported in the ‚Äúwebpack‚Äù way will need to be imported in a new way: [docs](https://vitejs.dev/guide/features.html#web-workers)
8. App.jsx entrypoint is no longer quietly added if a plugin entrypoint is defined or for a defined but empty entrypoints object
9. Plugins and apps are started together in the same process on the same port
10. The `PORT` env var is removed
11. `import * as MyClass from ‚Äòmy-module‚Äô` is now more restrictive, and may break in some cases. So far, changing the import to `import MyClass from ‚Äòmy-module‚Äô` has fixed it. DOMPurify is one example case, noticed in the Login App
12. [React 18 stuff ‚Äî todo]

### Deprecations

-   Environment variables on `process.env` will be dropped in future versions, in favor of variables on `import.meta.env`
-   The default `direction` config value is `ltr`; in the future, it will be `auto`
-   `--allowJsxInJs` will be removed
-   some niche PWA config caching option names will be removed
